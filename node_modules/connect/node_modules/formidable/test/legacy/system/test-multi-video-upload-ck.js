var common=require("../common"),BOUNDARY="---------------------------10102754414578508781458777923",FIXTURE=TEST_FIXTURES+"/multi_video.upload",fs=require("fs"),util=require(common.lib+"/util"),http=require("http"),formidable=require(common.lib+"/index"),server=http.createServer();server.on("request",function(e,t){var n=new formidable.IncomingForm,r={};n.uploadDir=TEST_TMP;n.parse(e);n.on("fileBegin",function(e,t){assert.equal(e,"upload");var n={file:t,progress:[],ended:!1};r[t.filename]=n;t.on("progress",function(e){n.progress.push(e);assert.equal(e,t.length)}).on("end",function(){n.ended=!0})}).on("field",function(e,t){assert.equal(e,"title");assert.equal(t,"")}).on("file",function(e,t){assert.equal(e,"upload");assert.strictEqual(r[t.filename].file,t)}).on("end",function(){assert.ok(r["shortest_video.flv"]);assert.ok(r["shortest_video.flv"].ended);assert.ok(r["shortest_video.flv"].progress.length>3);assert.equal(r["shortest_video.flv"].progress.slice(-1),r["shortest_video.flv"].file.length);assert.ok(r["shortest_video.mp4"]);assert.ok(r["shortest_video.mp4"].ended);assert.ok(r["shortest_video.mp4"].progress.length>3);server.close();t.writeHead(200);t.end("good")})});server.listen(TEST_PORT,function(){var e=http.createClient(TEST_PORT),t=fs.statSync(FIXTURE),n={"content-type":"multipart/form-data; boundary="+BOUNDARY,"content-length":t.size};request=e.request("POST","/",n),fixture=new fs.ReadStream(FIXTURE);fixture.on("data",function(e){request.write(e)}).on("end",function(){request.end()})});
#!/usr/bin/env node

'use strict';

try {
	var optimist = require('optimist');
	var less = require('less');
  var wrench = require("wrench");
  var ugly = require('uglify-js');
  var colors = require('colors');
  var watchr = require('watch_r');
}catch(e){
	console.log('install required dependencies with this command:');
	console.log('npm install optimist less wrench uglify-js colors watch_r');
	process.exit(1)
}

var fs = require('fs');
var path = require('path');
var http = require('http');
var url = require("url");

var bootstrap_dir = fs.realpathSync(__dirname + "/..");

var usage = "This will build your Twitter Bootstrap project\n\nUsage: " .white + "$0 ".red + "[" .white + "target" .blue + "]\n\nAvailable targets:" .white;
usage += "\n  clean" . blue + " - cleanup (delete) all targets from distro" . white;

var targets = fs.readdirSync(__dirname + '/targets');

targets.forEach(function(name){
  if (name[0]!='.'){
    var pkginfo = require("./targets/" + name + '/build/package.json');
    usage += "\n  " + name.blue + " - " + pkginfo.description . white;
  }
});

var argv = optimist.usage(usage)
  .describe('directory', 'Output directory (not including target name.)')

  .alias('x', 'development')
  .boolean('x')
  .describe('x', "Don't compress & minify Javascript & CSS.")

  .alias('t', 'test')
  .boolean('t')
  .describe('t', 'Run jshint & qunit in phantomjs.')

  .alias('w', 'watch')
  .boolean('w')
  .describe('w', 'Watch for changes in the target files, recompile.')

  .alias('s', 'serve')
  .boolean('s')
  .describe('s', "Provide a webserver on given port, combines nicely with --watch")

  .alias('p', 'port')
  .describe('p', "Port for webserver.")

  .default({
    "directory" : bootstrap_dir + '/dist',
    "p" : 8080
  }).argv;

var target = argv._[0];
argv.target = target;

argv.production = ! argv.development;

function copyFileSync(srcFile, destFile) {
  var BUF_LENGTH, buff, bytesRead, fdr, fdw, pos;
  BUF_LENGTH = 64 * 1024;
  buff = new Buffer(BUF_LENGTH);
  fdr = fs.openSync(srcFile, 'r');
  fdw = fs.openSync(destFile, 'w');
  bytesRead = 1;
  pos = 0;
  while (bytesRead > 0) {
    bytesRead = fs.readSync(fdr, buff, 0, BUF_LENGTH, pos);
    fs.writeSync(fdw, buff, 0, bytesRead);
    pos += bytesRead;
  }
  fs.closeSync(fdr);
  return fs.closeSync(fdw);
};

/**
 * given infile & outfile, process LESS, output file, then optionally run callback
 * @param  {String}   infile   file with LESS directives
 * @param  {String}   outfile  outputted, minified CSS
 * @param  {Function} callback paramters are (err, infile, outfile, source-text)
 */
function lessify(infile, outfile, minify, callback){
	callback = callback || function(err, infile, outfile, source){};
  minify = (minify == undefined) ? true : minify;

  var less_dir = path.resolve(path.dirname(infile));
	var parser = new(less.Parser)({ filename: infile, paths: ['.', less_dir] });
	fs.readFile(infile, function(err, less_data){
		if (err){
			return callback(err);
		}
    parser.parse(less_data + "", function (e, tree) {
        var css = tree.toCSS({ compress: minify }); // Minify CSS output
        fs.writeFile(outfile, css, function (err) {
          callback(err, infile, outfile, css);
        });
    });
	});
}

/**
 * given infile & outfile, minify javascript, output file, then optionally run callback
 * @param  {String}   infile   input javascript filename
 * @param  {String}   outfile  output javascript filename
 * @param  {Function} callback paramters are (err, infile, outfile, source-text)
 */
function uglify(infile, outfile, callback){
  callback = callback || function(err, infile, outfile, source){};
  var jsp = ugly.parser;
  var pro = ugly.uglify;

  fs.readFile(infile, function(err, orig_code){
    orig_code = orig_code + "";
    if (err){
      return callback(err, infile, outfile, orig_code);
    }
    var ast = jsp.parse(orig_code);
    ast = pro.ast_mangle(ast, {toplevel:true});
    ast = pro.ast_squeeze(ast);
    var final_code = pro.gen_code(ast);
    fs.writeFile(outfile, final_code, function(err){
      callback(err, infile, outfile, final_code);
    });
  });
}

colors.setTheme({
  "info":"green",
  "warn":"yellow",
  "error":"red"
});

/**
 * target-labeled console message
 * @param  {String} message [description]
 */
function msg(message){
  console.log("[".white + target.info + "] " + message.white);
}

/**
 * target-labeled console error
 * @param  {String} message [description]
 */
function error(message){
  console.log("[".white + target.error + "] " + message.white);
  process.exit(1);
}

/**
 * Builds full bootstrap in given dir
 * @param  {String} dir Directory to build it in
 * @param  {Boolean} combineJs [description]
 * @param  {Boolean} minifyJs  [description]
 * @param  {Boolean} minifyCss [description]
 */
function makelib(dir, combineJs, minifyJs, minifyCss){
  // make bootstrap dir
  fs.mkdir(dir, function(err){
    if (err && err.code != 'EEXIST'){
      error('  error creating dir for bootstrap.');
    }

    // uglify JS
    fs.mkdir(dir + "/js", function(err){
      if (err && err.code != 'EEXIST'){
        error('  error creating dir for javascript.');
      }
      msg("creating bootstrap javascript.");

      var curFiles=[
        'bootstrap-transition.js',
        'bootstrap-alert.js',
        'bootstrap-modal.js',
        'bootstrap-dropdown.js',
        'bootstrap-scrollspy.js',
        'bootstrap-tab.js',
        'bootstrap-tooltip.js',
        'bootstrap-popover.js',
        'bootstrap-button.js',
        'bootstrap-collapse.js',
        'bootstrap-carousel.js',
        'bootstrap-typeahead.js',
        'bootstrap-affix.js'
      ];

      var out="";
      curFiles.forEach(function(name, i){
        if (combineJs){
          out += "\n" + fs.readFileSync(bootstrap_dir + "/js/" + name);
          if (i == curFiles.length-1){
            fs.writeFileSync(dir + "/js/bootstrap.js", out);
            if(minifyJs){
              uglify(dir + "/js/bootstrap.js", dir + "/js/bootstrap.min.js");
            }
          }
        }else{
          uglify(bootstrap_dir + "/js/" + name, dir + "/js/" + name);
        }
      });
    });

    // compile LESS
    msg("compiling bootstrap LESS.");
    fs.mkdir(dir + "/css", function(err){
      if (err && err.code != 'EEXIST'){
        error('error creating dir for LESS.');
      }
      lessify(bootstrap_dir + "/less/bootstrap.less", dir + "/css/bootstrap.css", minifyCss)
      lessify(bootstrap_dir + "/less/responsive.less", dir + "/css/bootstrap-responsive.css", minifyCss);
    });

    // copy images
    msg("copying bootstrap images.");
    fs.mkdir(dir + "/img", function(err){
      if (err && err.code != 'EEXIST'){
        error('error creating dir for images.');
      }
      copyFileSync(bootstrap_dir + "/img/glyphicons-halflings-white.png", dir + "/img/glyphicons-halflings-white.png");
      copyFileSync(bootstrap_dir + "/img/glyphicons-halflings.png", dir + "/img/glyphicons-halflings.png");
    });
  });
}


function compile(changed_file){
  // TODO: watch for specific build portion to rebuild
  msg("copying target assets.");
  wrench.mkdirSyncRecursive(argv.directory + '/' + target + '/assets');
  wrench.copyDirSyncRecursive(bootstrap_dir + "/build/targets/" + target + '/assets/', argv.directory + '/' + target + '/assets/');

  makelib(argv.directory + '/' + target + '/assets/', argv.production, argv.production, argv.production);

  msg("building target.");
  require("./targets/" + target + '/build').build(argv);
}

// do initial build for watch support 
if (argv.watch && !fs.existsSync(argv.directory + '/' + target)){
  compile();
  wrench.mkdirSyncRecursive(argv.directory + '/' + target);
}

if (argv.serve && target != "clean" && target){
  http.createServer(function(request, response) {
    var uri = url.parse(request.url).pathname
      , filename = path.join(argv.directory, target, uri);
    
    fs.exists(filename, function(exists) {
      if(!exists) {
        response.writeHead(404, {"Content-Type": "text/plain"});
        response.write("404 Not Found\n");
        response.end();
        return;
      }

    if (fs.statSync(filename).isDirectory()) filename += '/index.html';

      fs.readFile(filename, "binary", function(err, file) {
        if(err) {        
          response.writeHead(500, {"Content-Type": "text/plain"});
          response.write(err + "\n");
          response.end();
          return;
        }

        response.writeHead(200);
        response.write(file, "binary");
        response.end();
      });
    });
  }).listen(parseInt(argv.port, 10));
  msg('Server running at http://127.0.0.1:' + argv.port + '/');
}

if (argv.watch && target != "clean" && target ){
  msg("watching files in " + bootstrap_dir + "/build/targets/" + target + ", less & js for changes. hit Ctrl-C to stop.");

  watchr(bootstrap_dir + "/build/targets/" + target, function(err, watcher) {
    watcher.on('change', compile);
    watcher.on('remove', compile);
  });

  watchr(bootstrap_dir + "/js/", function(err, watcher) {
    watcher.on('change', compile);
    watcher.on('remove', compile);
  });

  watchr(bootstrap_dir + "/less/", function(err, watcher) {
    watcher.on('change', compile);
    watcher.on('remove', compile);
  });

}else{
  if (target == 'clean'){
      msg("delete all files in " + argv.directory);
      wrench.rmdirSyncRecursive(argv.directory, true);
  }else if (targets.indexOf(target) != -1){
    compile();
  }else{
    require('optimist').showHelp();
  }
}

